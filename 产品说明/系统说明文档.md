# 人民城轨2.0系统说明文档

## 1. 系统概述

人民城轨2.0是一个综合性的后台管理系统，集成了AI管理、情景管理、文创管理、直播管理、审核管理等多个功能模块，为企业提供全面的内容管理和数据展示解决方案。本系统旨在简化管理工作，提高运营效率，支持大屏幕数据展示和情景播放功能。

## 1. 系统概述

AI管理功能是人民城轨2.0后台管理系统的重要组成部分，旨在为企业提供集中化的AI智能体和知识库管理能力。该功能模块与现有的文创管理、直播管理、系统管理等模块平级，通过统一的界面和操作流程，简化AI资源的管理和维护工作。

## 2. 系统架构

### 2.1 整体架构

人民城轨2.0系统采用前后端分离的开发模式：

- **前端**：基于React框架开发，结合Element UI组件库构建用户界面
- **后端**：提供RESTful API接口，处理业务逻辑和数据持久化
- **数据存储**：
  - 结构化数据（智能体配置、知识库信息）：关系型数据库
  - 非结构化数据（文档文件）：文件存储服务

### 2.2 功能模块架构

```
人民城轨2.0系统
├── AI管理模块
│   ├── 智能体管理
│   └── 知识库管理
├── 情景管理模块
│   ├── 情景CRUD操作
│   ├── 情景播放控制
│   ├── 大屏管理
│   └── 播放模式设置
├── 文创管理模块
├── 直播管理模块
├── 审核管理模块
├── 展会管理模块
├── 运营管理模块
├── 大屏运营模块
│   ├── 大屏管理
│   ├── 背景墙管理
└── 系统管理模块
    ├── 用户管理
    ├── 角色管理
    └── 系统设置
```

### 2.3 数据流设计

1. **智能体数据流**：
   - 用户界面 → 前端组件 → API服务 → 后端业务逻辑 → 数据库
   - 数据库 → 后端业务逻辑 → API服务 → 前端组件 → 用户界面

2. **知识库数据流**：
   - 配置数据：与智能体数据流相同
   - 文件数据：用户界面 → 文件上传组件 → 上传服务 → 文件存储 → 元数据保存至数据库

## 3. 技术栈

### 3.1 前端技术栈

| 技术/框架 | 版本 | 用途 | 备注 |
|----------|------|------|------|
| React | 最新版 | 前端框架 | 用于构建用户界面 |
| Ant Design (antd) | 最新版 | UI组件库 | 提供丰富的UI组件 |
| React Router | 最新版 | 路由管理 | 处理页面导航 |
| Redux | 最新版 | 状态管理 | 管理应用状态 |
| Axios | 最新版 | HTTP客户端 | 发起API请求 |
| FontAwesome | 6.x | 图标库 | 提供界面图标 |
| 原生JavaScript | ES6+ | 开发语言 | 使用React.createElement()替代JSX语法，确保与现有系统兼容 |

### 3.2 后端技术栈（预计）

| 技术/框架 | 版本 | 用途 | 备注 |
|----------|------|------|------|
| Node.js | 14.x+ | 运行环境 | 服务器端JavaScript运行环境 |
| Express.js | 最新版 | Web框架 | 构建RESTful API |
| MongoDB/MySQL | 最新版 | 数据库 | 存储结构化数据 |
| Redis | 最新版 | 缓存 | 提高性能和可用性 |
| AWS S3/阿里云OSS | - | 对象存储 | 存储文档文件 |

## 4. 依赖关系

### 4.1 前端依赖

- **核心依赖**：
  - `react`：核心框架
  - `antd`：UI组件库
  - `@ant-design/icons`：图标支持
  - `react-router-dom`：路由管理

- **工具依赖**：
  - `axios`：HTTP请求
  - `lodash`：工具函数库
  - `moment`：日期时间处理
  - `file-saver`：文件下载

### 4.2 与现有系统的集成依赖

- **菜单管理系统**：通过修改MenuManagement.js和Navigation.js文件集成到系统菜单
- **权限管理系统**：复用现有角色权限数据，实现智能体使用权限控制
- **用户认证系统**：复用现有认证机制，确保只有授权用户可访问

## 5. 运行环境

### 5.1 开发环境

- **操作系统**：Windows/macOS/Linux
- **Node.js**：v14.x 或更高版本
- **npm/yarn**：最新稳定版
- **浏览器**：Chrome 90+，Firefox 88+，Safari 14+，Edge 90+

### 5.2 生产环境

- **服务器**：Linux服务器（推荐CentOS 7+或Ubuntu 20.04+）
- **Node.js**：v14.x 或更高版本（建议使用PM2进行进程管理）
- **Web服务器**：Nginx（用于静态资源托管和反向代理）
- **数据库**：根据后端选择的数据库系统
- **文件存储**：云存储服务或自建文件服务器

## 6. 关键模块说明

### 6.1 情景管理模块

#### 6.1.1 功能描述
提供大屏情景的创建、编辑、删除和播放管理功能，支持多大屏配置、播放模式设置和时长控制，实现大屏内容的灵活编排和自动化播放。

#### 6.1.2 核心组件
- **ScenarioManagement_v2.js**：情景管理主页面组件
- **mockData.js**：提供模拟数据支持

#### 6.1.3 核心功能点
- 情景列表展示和搜索
- 情景创建和编辑
- 情景删除功能
- 播放模式设置（顺序播放/随机播放）
- 大屏关联和配置
- 大屏显示时长设置
- 大屏顺序调整
- 情景保存和状态管理

### 6.2 智能体管理模块

#### 6.1.1 功能描述
提供AI智能体的全生命周期管理，包括创建、配置、权限分配、状态管理等功能。

#### 6.1.2 核心组件
- **AIAgentManagement.js**：智能体管理主页面组件
- **AgentForm.js**：智能体表单组件（用于新增和编辑）
- **PermissionSelector.js**：权限选择组件
- **KnowledgeBaseSelector.js**：知识库选择组件

#### 6.1.3 核心功能点
- 智能体信息管理
- 模型和提示词配置
- 多知识库关联
- 基于角色的权限控制
- 启用/禁用状态切换

### 6.2 知识库管理模块

#### 6.2.1 功能描述
提供知识库的创建、管理和文档文件的上传、下载、删除等功能。

#### 6.2.2 核心组件
- **AIKnowledgeManagement.js**：知识库管理主页面组件
- **KnowledgeBaseForm.js**：知识库表单组件
- **FileManager.js**：文件管理组件
- **FileUploader.js**：文件上传组件

#### 6.2.3 核心功能点
- 知识库信息管理
- 多格式文档上传（PDF、Word、PPT、TXT等）
- 文件列表展示和搜索
- 文件下载和删除
- 知识库启用/禁用状态切换

## 7. API接口设计

### 7.1 情景管理接口

| API路径 | 方法 | 功能描述 | 请求体 (JSON) | 成功响应 (200 OK) |
|---------|------|---------|--------------|------------------|
| `/api/scenarios` | GET | 获取情景列表 | N/A | `{"data": [{情景对象}], "total": 10}` |
| `/api/scenarios` | POST | 创建情景 | `{"name": "", "description": "", "playMode": "", "screens": []}` | `{"id": "", "name": "", ...}` |
| `/api/scenarios/:id` | GET | 获取情景详情 | N/A | `{"id": "", "name": "", ...}` |
| `/api/scenarios/:id` | PUT | 更新情景 | `{"name": "", "description": "", ...}` | `{"id": "", "name": "", ...}` |
| `/api/scenarios/:id` | DELETE | 删除情景 | N/A | `{"success": true}` |
| `/api/scenarios/:id/play` | POST | 播放情景 | N/A | `{"success": true}` |

### 7.2 智能体管理接口

| API路径 | 方法 | 功能描述 | 请求体 (JSON) | 成功响应 (200 OK) |
|---------|------|---------|--------------|------------------|
| `/api/ai/agents` | GET | 获取智能体列表 | N/A | `{"data": [{智能体对象}], "total": 10}` |
| `/api/ai/agents` | POST | 创建智能体 | `{"name": "", "description": "", "model": "", "prompt": "", "knowledgeBases": [], "roles": [], "enabled": true}` | `{"id": "", "name": "", ...}` |
| `/api/ai/agents/:id` | GET | 获取智能体详情 | N/A | `{"id": "", "name": "", ...}` |
| `/api/ai/agents/:id` | PUT | 更新智能体 | `{"name": "", "description": "", ...}` | `{"id": "", "name": "", ...}` |
| `/api/ai/agents/:id` | DELETE | 删除智能体 | N/A | `{"success": true}` |
| `/api/ai/agents/:id/status` | PATCH | 更新智能体状态 | `{"enabled": true}` | `{"success": true}` |

### 7.2 知识库管理接口

| API路径 | 方法 | 功能描述 | 请求体 (JSON) | 成功响应 (200 OK) |
|---------|------|---------|--------------|------------------|
| `/api/ai/knowledge-bases` | GET | 获取知识库列表 | N/A | `{"data": [{知识库对象}], "total": 5}` |
| `/api/ai/knowledge-bases` | POST | 创建知识库 | `{"name": "", "description": "", "enabled": true}` | `{"id": "", "name": "", ...}` |
| `/api/ai/knowledge-bases/:id` | GET | 获取知识库详情 | N/A | `{"id": "", "name": "", ...}` |
| `/api/ai/knowledge-bases/:id` | PUT | 更新知识库 | `{"name": "", "description": "", ...}` | `{"id": "", "name": "", ...}` |
| `/api/ai/knowledge-bases/:id` | DELETE | 删除知识库 | N/A | `{"success": true}` |
| `/api/ai/knowledge-bases/:id/status` | PATCH | 更新知识库状态 | `{"enabled": true}` | `{"success": true}` |

### 7.3 文件管理接口

| API路径 | 方法 | 功能描述 | 请求体 | 成功响应 (200 OK) |
|---------|------|---------|-------|------------------|
| `/api/ai/knowledge-bases/:id/files` | GET | 获取知识库文件列表 | N/A | `{"data": [{文件对象}], "total": 10}` |
| `/api/ai/knowledge-bases/:id/files` | POST | 上传文件 | FormData | `{"id": "", "fileName": "", ...}` |
| `/api/ai/files/:id` | DELETE | 删除文件 | N/A | `{"success": true}` |
| `/api/ai/files/:id/download` | GET | 下载文件 | N/A | 文件流 |

## 8. 数据模型设计

### 8.1 情景模型 (Scenario)

| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| `id` | `VARCHAR(36)` | `PRIMARY KEY` | 情景唯一标识 |
| `name` | `VARCHAR(100)` | `NOT NULL` | 情景名称 |
| `description` | `TEXT` | `NOT NULL` | 情景描述 |
| `playMode` | `VARCHAR(20)` | `NOT NULL` | 播放模式（sequence/random） |
| `created_at` | `TIMESTAMP` | `DEFAULT CURRENT_TIMESTAMP` | 创建时间 |
| `updated_at` | `TIMESTAMP` | `DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP` | 更新时间 |

### 8.2 情景-大屏关联模型 (Scenario_Screen)

| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| `id` | `VARCHAR(36)` | `PRIMARY KEY` | 关联ID |
| `scenario_id` | `VARCHAR(36)` | `NOT NULL, FOREIGN KEY` | 情景ID |
| `screen_id` | `VARCHAR(36)` | `NOT NULL, FOREIGN KEY` | 大屏ID |
| `display_time` | `INT` | `NOT NULL` | 显示时长（秒） |
| `order_index` | `INT` | `NOT NULL` | 显示顺序 |

### 8.3 大屏模型 (Screen)

| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| `id` | `VARCHAR(36)` | `PRIMARY KEY` | 大屏唯一标识 |
| `name` | `VARCHAR(100)` | `NOT NULL` | 大屏名称 |
| `description` | `TEXT` | | 大屏描述 |
| `location` | `VARCHAR(200)` | | 大屏位置 |
| `status` | `VARCHAR(20)` | `DEFAULT 'active'` | 大屏状态 |
| `created_at` | `TIMESTAMP` | `DEFAULT CURRENT_TIMESTAMP` | 创建时间 |
| `updated_at` | `TIMESTAMP` | `DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP` | 更新时间 |

### 8.4 智能体模型 (AI_Agent)

| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| `id` | `VARCHAR(36)` | `PRIMARY KEY` | 智能体唯一标识 |
| `name` | `VARCHAR(100)` | `NOT NULL` | 智能体名称 |
| `description` | `TEXT` | `NOT NULL` | 智能体简介 |
| `model` | `VARCHAR(50)` | `NOT NULL` | AI模型类型 |
| `prompt` | `TEXT` | `NOT NULL` | 提示词配置 |
| `enabled` | `BOOLEAN` | `DEFAULT TRUE` | 是否启用 |
| `created_at` | `TIMESTAMP` | `DEFAULT CURRENT_TIMESTAMP` | 创建时间 |
| `updated_at` | `TIMESTAMP` | `DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP` | 更新时间 |

### 8.2 知识库模型 (Knowledge_Base)

| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| `id` | `VARCHAR(36)` | `PRIMARY KEY` | 知识库唯一标识 |
| `name` | `VARCHAR(100)` | `NOT NULL` | 知识库名称 |
| `description` | `TEXT` | `NOT NULL` | 知识库简介 |
| `enabled` | `BOOLEAN` | `DEFAULT TRUE` | 是否启用 |
| `file_count` | `INT` | `DEFAULT 0` | 文件数量 |
| `created_at` | `TIMESTAMP` | `DEFAULT CURRENT_TIMESTAMP` | 创建时间 |
| `updated_at` | `TIMESTAMP` | `DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP` | 更新时间 |

### 8.3 知识库文件模型 (KB_File)

| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| `id` | `VARCHAR(36)` | `PRIMARY KEY` | 文件唯一标识 |
| `knowledge_base_id` | `VARCHAR(36)` | `NOT NULL, FOREIGN KEY` | 所属知识库ID |
| `file_name` | `VARCHAR(255)` | `NOT NULL` | 文件名称 |
| `file_type` | `VARCHAR(50)` | `NOT NULL` | 文件类型 |
| `file_size` | `BIGINT` | `NOT NULL` | 文件大小（字节） |
| `file_path` | `VARCHAR(500)` | `NOT NULL` | 文件存储路径 |
| `uploaded_by` | `VARCHAR(50)` | `NOT NULL` | 上传人 |
| `uploaded_at` | `TIMESTAMP` | `DEFAULT CURRENT_TIMESTAMP` | 上传时间 |

### 8.4 智能体-知识库关联模型 (Agent_KB_Relation)

| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| `id` | `VARCHAR(36)` | `PRIMARY KEY` | 关联ID |
| `agent_id` | `VARCHAR(36)` | `NOT NULL, FOREIGN KEY` | 智能体ID |
| `knowledge_base_id` | `VARCHAR(36)` | `NOT NULL, FOREIGN KEY` | 知识库ID |

### 8.5 智能体-角色关联模型 (Agent_Role_Relation)

| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| `id` | `VARCHAR(36)` | `PRIMARY KEY` | 关联ID |
| `agent_id` | `VARCHAR(36)` | `NOT NULL, FOREIGN KEY` | 智能体ID |
| `role_id` | `VARCHAR(36)` | `NOT NULL, FOREIGN KEY` | 角色ID |

## 9. 安全设计

### 9.1 认证与授权

- **用户认证**：复用现有系统的认证机制，确保只有登录用户可访问
- **权限控制**：基于角色的访问控制（RBAC），只有管理员角色可进行增删改操作
- **操作日志**：记录所有关键操作，便于审计和问题排查

### 9.2 数据安全

- **传输加密**：所有数据传输采用HTTPS加密
- **存储安全**：
  - 敏感配置信息加密存储
  - 文件存储实施访问控制
- **数据备份**：定期对数据库和文件进行备份

### 9.3 输入验证

- **前端验证**：对所有用户输入进行格式和范围验证
- **后端验证**：服务端再次验证所有请求参数，防止恶意输入
- **文件上传验证**：严格验证文件类型和大小，防止恶意文件上传

## 10. 性能优化

### 10.1 前端优化

- **懒加载**：组件按需加载，减少初始加载时间
- **虚拟滚动**：大数据列表使用虚拟滚动，提高渲染性能
- **缓存策略**：合理使用浏览器缓存和本地存储
- **请求优化**：使用防抖、节流等技术减少不必要的请求

### 10.2 后端优化

- **数据库索引**：为常用查询字段创建索引
- **查询优化**：优化SQL查询，避免全表扫描
- **缓存机制**：使用Redis缓存热点数据
- **异步处理**：文件上传等耗时操作采用异步处理

## 11. 部署说明

### 11.1 前端部署

1. **构建流程**：
   - 执行 `npm install` 安装依赖
   - 执行 `npm run build` 构建生产版本
   - 将构建产物部署到Web服务器

2. **Nginx配置示例**：
```nginx
server {
    listen 80;
    server_name example.com;
    
    location / {
        root /path/to/build;
        index index.html;
        try_files $uri $uri/ /index.html;
    }
    
    location /api {
        proxy_pass http://backend-server:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

### 11.2 后端部署

1. **环境准备**：
   - 安装Node.js和依赖
   - 配置数据库和文件存储

2. **启动服务**：
   - 使用PM2进行进程管理：`pm2 start app.js --name ai-management`
   - 配置自动重启：`pm2 startup`

## 12. 监控与维护

### 12.1 日志管理

- **应用日志**：记录系统运行状态和错误信息
- **访问日志**：记录API访问情况
- **错误日志**：记录异常和错误堆栈

### 12.2 监控指标

- **系统指标**：CPU、内存、磁盘使用率
- **应用指标**：响应时间、请求成功率、并发用户数
- **业务指标**：智能体调用次数、知识库使用情况

### 12.3 常见问题排查

- **连接失败**：检查网络配置和服务状态
- **权限错误**：检查用户角色和权限设置
- **上传失败**：检查文件大小限制和存储配置
- **性能问题**：分析日志和监控数据，定位瓶颈

## 13. 版本历史

| 日期 | 版本 | 更新内容 | 更新人 |
|------|------|---------|--------|
| 2024-01-22 | V1.2 | 增加情景管理功能模块，支持大屏情景的创建、编辑、删除和播放管理 | 开发团队 |
| 2024-01-21 | V1.1 | 优化前端实现，使用原生JavaScript和React.createElement()替代JSX语法，确保系统兼容性 | 开发团队 |
| 2024-01-20 | V1.0 | 初始版本 | 技术团队 |