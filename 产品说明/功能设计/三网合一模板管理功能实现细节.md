# 三网合一功能 - 模板管理实现细节

## 1. 文档信息
- **文档版本**：V1.0
- **创建日期**：2025-11-07
- **文档状态**：初稿
- **作者**：产品技术负责人

## 2. 功能概述
模板管理功能用于支持三网合一内容发布中的模板创建、编辑、删除和预览操作。该功能允许管理员根据不同平台特性设计专用内容模板，确保内容在各平台显示效果一致且专业。

## 3. 组件结构设计

### 3.1 模板管理主组件 (TemplateManager.vue)
```javascript
// 组件结构
{
  name: 'TemplateManager',
  components: {
    TemplateList,
    TemplateEditor,
    TemplatePreview
  },
  data() {
    return {
      templates: [],
      loading: false,
      currentTemplate: null,
      editorVisible: false,
      previewVisible: false,
      previewData: {}
    }
  },
  methods: {
    fetchTemplates(),
    createTemplate(),
    editTemplate(template),
    deleteTemplate(id),
    previewTemplate(template),
    saveTemplate(data)
  }
}
```

### 3.2 模板列表组件 (TemplateList.vue)
```javascript
// 组件结构
{
  name: 'TemplateList',
  props: {
    templates: Array,
    loading: Boolean
  },
  emits: ['edit', 'delete', 'preview'],
  data() {
    return {
      filter: {
        name: '',
        type: ''
      }
    }
  },
  computed: {
    filteredTemplates() {
      // 根据过滤条件返回模板列表
    }
  }
}
```

### 3.3 模板编辑器组件 (TemplateEditor.vue)
```javascript
// 组件结构
{
  name: 'TemplateEditor',
  props: {
    template: Object,
    visible: Boolean
  },
  emits: ['save', 'cancel'],
  data() {
    return {
      form: {
        name: '',
        type: 'general',
        content: '',
        variables: []
      },
      rules: {
        name: [{ required: true, message: '请输入模板名称', trigger: 'blur' }],
        content: [{ required: true, message: '请输入模板内容', trigger: 'blur' }]
      },
      variableForm: {
        name: '',
        description: '',
        type: 'string'
      }
    }
  },
  watch: {
    template: {
      handler(newVal) {
        // 当传入的模板变化时，更新表单数据
      },
      deep: true,
      immediate: true
    }
  },
  methods: {
    addVariable(),
    removeVariable(index),
    handleSubmit(),
    handleCancel()
  }
}
```

### 3.4 模板预览组件 (TemplatePreview.vue)
```javascript
// 组件结构
{
  name: 'TemplatePreview',
  props: {
    template: Object,
    visible: Boolean,
    previewData: Object
  },
  emits: ['close'],
  data() {
    return {
      deviceSize: 'desktop', // desktop, tablet, mobile
      renderedContent: ''
    }
  },
  watch: {
    template: {
      handler() {
        this.renderTemplate()
      },
      deep: true
    },
    previewData: {
      handler() {
        this.renderTemplate()
      },
      deep: true
    }
  },
  methods: {
    renderTemplate(), // 渲染模板内容
    switchDeviceSize(size),
    handleClose()
  }
}
```

## 4. 数据模型设计

### 4.1 模板数据结构
```javascript
// 完整的模板数据结构
{
  id: 'string',           // 模板唯一标识
  name: 'string',         // 模板名称
  type: 'string',         // 模板类型: 'general', 'app', 'website', 'wechat'
  content: 'string',      // HTML模板内容
  variables: [            // 模板变量定义
    {
      name: 'string',     // 变量名
      description: 'string', // 变量描述
      type: 'string',     // 变量类型: 'string', 'number', 'html', 'image'
      required: 'boolean' // 是否必填
    }
  ],
  createdAt: 'Date',      // 创建时间
  updatedAt: 'Date',      // 更新时间
  createdBy: 'string'     // 创建人
}
```

### 4.2 模板内容变量系统

#### 4.2.1 变量格式定义
在模板HTML内容中，使用双花括号 `{{ variableName }}` 表示变量占位符，例如：
```html
<h1>{{ title }}</h1>
<div class="content">{{ content }}</div>
<img src="{{ coverImage }}" alt="封面图">
```

#### 4.2.2 变量类型及处理规则
| 变量类型 | 描述 | 处理规则 |
|---------|------|----------|
| string  | 普通文本 | 直接替换，自动进行HTML转义 |
| number  | 数字 | 转换为字符串后替换 |
| html    | HTML内容 | 直接替换，不进行HTML转义 |
| image   | 图片URL | 用于图片src属性 |

## 5. API接口设计

### 5.1 获取模板列表
```
GET /api/templates
参数：
- type: 可选，模板类型筛选
- page: 可选，页码
- pageSize: 可选，每页数量

返回：
{
  success: true,
  data: {
    list: [模板对象数组],
    total: 总数,
    page: 当前页,
    pageSize: 每页数量
  }
}
```

### 5.2 获取单个模板
```
GET /api/templates/:id

返回：
{
  success: true,
  data: 模板对象
}
```

### 5.3 创建模板
```
POST /api/templates
参数：
{
  name: 模板名称,
  type: 模板类型,
  content: 模板内容,
  variables: 变量数组
}

返回：
{
  success: true,
  data: 创建的模板对象
}
```

### 5.4 更新模板
```
PUT /api/templates/:id
参数：
{
  name: 模板名称,
  type: 模板类型,
  content: 模板内容,
  variables: 变量数组
}

返回：
{
  success: true,
  data: 更新后的模板对象
}
```

### 5.5 删除模板
```
DELETE /api/templates/:id

返回：
{
  success: true,
  message: '删除成功'
}
```

## 6. 模板渲染引擎实现

### 6.1 核心渲染逻辑
```javascript
// 模板渲染函数示例
function renderTemplate(template, data) {
  let content = template.content;
  
  // 遍历模板中的所有变量
  template.variables.forEach(variable => {
    const regex = new RegExp(`\\{\\{\\s*${variable.name}\\s*\\}\\}`, 'g');
    
    // 检查数据中是否包含该变量
    if (!(variable.name in data)) {
      if (variable.required) {
        throw new Error(`缺少必填变量: ${variable.name}`);
      }
      // 非必填变量，使用空字符串替换
      content = content.replace(regex, '');
    } else {
      // 根据变量类型进行不同的处理
      let value = data[variable.name];
      
      switch (variable.type) {
        case 'string':
          // 字符串类型，进行HTML转义
          value = escapeHtml(value);
          break;
        case 'html':
          // HTML类型，不进行转义
          break;
        case 'number':
          // 数字类型，转换为字符串
          value = String(value);
          break;
        case 'image':
          // 图片类型，直接使用URL
          break;
        default:
          // 默认为字符串类型
          value = escapeHtml(String(value));
      }
      
      content = content.replace(regex, value);
    }
  });
  
  return content;
}

// HTML转义函数
function escapeHtml(text) {
  const map = {
    '&': '&amp;',
    '<': '&lt;',
    '>': '&gt;',
    '"': '&quot;',
    "'": '&#039;'
  };
  return text.replace(/[&<>"']/g, m => map[m]);
}
```

### 6.2 平台特性适配
针对不同平台的特殊要求，在渲染过程中增加平台特定的处理：

```javascript
function adaptTemplateForPlatform(content, platform) {
  switch (platform) {
    case 'app':
      // APP平台适配：调整图片尺寸、移除不支持的CSS
      content = adjustImageSize(content, 'app');
      content = removeUnsupportedCSS(content, 'app');
      break;
    case 'website':
      // 官网平台适配：添加响应式类、调整布局
      content = addResponsiveClasses(content);
      break;
    case 'wechat':
      // 公众号平台适配：简化HTML结构、调整字体大小
      content = simplifyHtml(content);
      content = adjustFontSize(content, 'wechat');
      break;
    default:
      // 默认适配处理
  }
  
  return content;
}
```

## 7. 模板预览功能实现

### 7.1 响应式预览
实现三种设备尺寸的预览功能：
- 桌面端 (1200px+)
- 平板端 (768px-1199px)
- 移动端 (<767px)

```javascript
// 预览组件中的设备切换逻辑
methods: {
  switchDeviceSize(size) {
    this.deviceSize = size;
    this.updatePreviewContainerSize();
    this.renderTemplate();
  },
  updatePreviewContainerSize() {
    const container = this.$refs.previewContainer;
    if (!container) return;
    
    switch (this.deviceSize) {
      case 'desktop':
        container.style.width = '1200px';
        break;
      case 'tablet':
        container.style.width = '768px';
        break;
      case 'mobile':
        container.style.width = '375px';
        break;
    }
  }
}
```

### 7.2 预览数据模拟
为了在预览时提供数据，实现默认数据生成功能：

```javascript
function generatePreviewData(template) {
  const data = {};
  
  template.variables.forEach(variable => {
    switch (variable.type) {
      case 'string':
        data[variable.name] = `这是${variable.description || variable.name}的示例文本`;
        break;
      case 'number':
        data[variable.name] = Math.floor(Math.random() * 1000);
        break;
      case 'html':
        data[variable.name] = `<p>这是${variable.description || variable.name}的HTML内容</p>`;
        break;
      case 'image':
        data[variable.name] = 'https://via.placeholder.com/300x200'; // 使用占位图
        break;
    }
  });
  
  return data;
}
```

## 8. 代码实现注意事项

### 8.1 安全考虑
- 模板内容的HTML需要进行安全过滤，防止XSS攻击
- 严格验证用户输入的变量名格式，避免注入攻击
- 对模板渲染结果进行二次验证，确保生成的HTML安全有效

### 8.2 性能优化
- 实现模板缓存机制，避免重复渲染
- 使用虚拟DOM进行高效渲染
- 对于复杂模板，考虑使用Web Worker进行渲染处理

### 8.3 兼容性处理
- 确保生成的HTML在各平台上都能正常显示
- 对不同平台的特殊要求进行适配处理
- 处理移动端设备的特殊交互需求

## 9. 测试策略

### 9.1 单元测试
- 测试模板渲染引擎的正确性
- 测试变量替换逻辑
- 测试平台适配功能

### 9.2 集成测试
- 测试模板管理与内容发布的集成
- 测试模板CRUD操作的完整性
- 测试预览功能在不同设备下的表现

### 9.3 用户测试
- 邀请内容编辑人员测试模板创建和编辑功能
- 收集用户对模板易用性的反馈
- 根据反馈优化模板管理界面和功能

## 10. 部署与版本管理

### 10.1 模板版本控制
实现简单的模板版本控制机制，记录模板的修改历史：
```javascript
// 模板历史记录结构
{
  templateId: 'string',
  version: 'number',
  content: 'string',
  variables: 'array',
  modifiedBy: 'string',
  modifiedAt: 'date'
}
```

### 10.2 部署建议
- 模板数据存储在数据库中，确保数据持久化
- 实现模板的导入/导出功能，便于迁移和备份
- 对模板进行分类管理，提高查找效率