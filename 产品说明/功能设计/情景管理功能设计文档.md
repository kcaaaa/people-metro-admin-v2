# 情景管理功能设计文档

## 1. 功能概述

情景管理是人民城轨2.0系统中的一个核心功能，允许用户自由组合多个大屏形成情景模式，根据不同访客群体区分展示内容。该功能与大屏管理、背景墙管理功能同级，为用户提供灵活的内容展示方案。用户可以设置播放模式（顺序播放/随机播放）以及大屏展示时长，满足不同的展示需求。系统支持情景的搜索、排序和筛选，方便用户快速定位和管理所需情景。

## 2. 核心功能点

### 2.1 情景的增删改查
- **创建情景**：用户可以创建新的情景，设置名称、描述、播放模式等信息
- **编辑情景**：用户可以修改已创建情景的各项属性
- **删除情景**：用户可以删除不再需要的情景
- **查询情景**：用户可以查看所有已创建的情景列表

### 2.2 情景搜索与筛选
- **关键词搜索**：用户可以通过情景名称或描述进行模糊搜索
- **实时搜索反馈**：随着用户输入即时显示搜索结果
- **搜索结果高亮**：匹配的关键词在搜索结果中高亮显示

### 2.3 播放模式设置
- **顺序播放**：按照设置的大屏顺序依次展示
- **随机播放**：随机切换展示不同的大屏内容

### 2.4 大屏展示时长配置
- **全局默认时长**：为播放模式设置默认的大屏展示时长
- **单个大屏时长**：为每个选中的大屏单独设置展示时长（5-300秒）
- **实时时长修改**：支持在编辑过程中实时修改大屏的展示时长

### 2.5 大屏组合管理
- **大屏选择**：从已有的大屏中选择需要包含在情景中的大屏
- **大屏排序**：调整大屏在情景中的展示顺序
- **大屏移除**：从情景中移除不需要的大屏

## 3. 数据结构

### 3.1 情景对象结构
```javascript
{
  id: String,          // 情景唯一标识符
  name: String,        // 情景名称
  description: String, // 情景描述
  playMode: String,    // 播放模式: 'sequence' 或 'random'
  defaultDuration: Number, // 默认播放时长（秒）
  screens: Array,      // 包含的大屏列表
  createdAt: String,   // 创建时间
  updatedAt: String,   // 更新时间
  createdBy: String    // 创建人
}
```

### 3.2 大屏在情景中的结构
```javascript
{
  screenId: String,    // 大屏唯一标识符
  name: String,        // 大屏名称
  duration: Number,    // 展示时长（秒）
  order: Number        // 展示顺序
}
```

## 4. 功能详细描述

### 4.1 情景列表管理

- **功能描述**：展示所有已创建的情景模式列表
- **输入**：无特殊输入
- **输出**：情景列表数据表格
- **交互逻辑**：
  - 页面加载时显示所有情景
  - 每个情景条目显示基本信息和操作按钮
  - 支持编辑和删除操作
  - 表格包含分页控件

### 4.2 情景创建

- **功能描述**：创建新的情景模式
- **输入**：情景名称、描述、播放形式、默认时长、大屏配置
- **输出**：创建成功提示，新情景显示在列表中
- **前置条件**：用户具有系统操作权限
- **后置条件**：新情景添加到数据存储中
- **验证规则**：
  - 情景名称不能为空
  - 至少选择一个大屏
  - 默认时长必须在5-300秒之间

### 4.3 情景编辑

- **功能描述**：修改现有情景的配置信息
- **输入**：更新后的情景信息（名称、描述、播放形式、时长、大屏配置等）
- **输出**：更新成功提示，列表中情景信息更新
- **前置条件**：选择一个现有情景
- **后置条件**：情景信息在数据存储中更新

### 4.4 情景删除

- **功能描述**：删除不需要的情景模式
- **输入**：情景ID
- **输出**：删除成功提示，列表中移除该情景
- **前置条件**：选择一个现有情景
- **后置条件**：情景从数据存储中移除
- **交互流程**：
  - 点击删除按钮
  - 弹出确认对话框
  - 确认后执行删除操作
  - 显示操作结果反馈

### 4.5 播放模式设置

- **功能描述**：设置情景的播放模式（顺序播放或随机播放）
- **输入**：播放模式选择
- **输出**：播放配置更新
- **交互逻辑**：
  - 通过单选框选择播放模式
  - 选择任何播放模式都需要设置默认时长
  - 切换播放模式时保留现有时长设置

### 4.6 展示时长配置

- **功能描述**：设置大屏的展示时长
- **输入**：时长数值（秒）
- **输出**：时长配置更新
- **交互逻辑**：
  - 默认时长为所有大屏的基础展示时间
  - 可针对单个大屏设置特定时长
  - 输入验证：时长必须在5-300秒之间
  - 实时显示错误提示

### 4.7 大屏组合配置

- **功能描述**：为情景选择和配置关联的大屏
- **输入**：选择的大屏列表、大屏顺序、时长设置
- **输出**：更新后的大屏组合配置
- **交互逻辑**：
  - 从现有大屏列表中选择
  - 调整大屏显示顺序
  - 为每个大屏设置独立的展示时长
  - 支持快速移除大屏

## 5. 业务流程图

```
用户访问情景管理页面
    │
    ▼
查看情景列表
    │
    ├───► 创建新情景
    │       │
    │       ▼
    │   设置基本信息
    │       │
    │       ▼
    │   选择播放模式
    │       │
    │       ▼
    │   配置默认时长
    │       │
    │       ▼
    │   选择并配置大屏
    │       │
    │       ▼
    │   保存情景
    │
    ├───► 编辑现有情景
    │       │
    │       ▼
    │   修改情景信息
    │       │
    │       ▼
    │   更新大屏配置
    │       │
    │       ▼
    │   保存更新
    │
    └───► 删除情景
            │
            ▼
        确认删除
            │
            ▼
        执行删除操作
```

## 6. 页面布局与交互设计

### 6.1 主页面布局
- 顶部操作栏：包含搜索框和"新增情景"按钮
- 数据表格：展示所有情景的基本信息（名称、描述、播放模式、大屏数量、创建时间）
- 操作列：每个情景条目包含"编辑"和"删除"操作按钮
- 分页控件：位于表格底部

### 6.2 编辑对话框布局
- **基本信息区域**：
  - 情景名称（必填）
  - 情景描述（可选）
  - 播放模式选择（单选框：顺序播放/随机播放）
  - 默认展示时长（必填，5-300秒）
- **大屏配置区域**：
  - 可用大屏列表（多选框）
  - 已选大屏列表（显示已选大屏，可调整顺序、修改时长、移除）
- 底部操作按钮：取消、保存

### 6.3 交互效果
- 点击"新增情景"按钮，打开编辑对话框
- 点击"编辑"按钮，打开编辑对话框并加载现有数据
- 点击"删除"按钮，弹出确认对话框
- 搜索框实时过滤情景列表
- 已选大屏支持通过按钮调整顺序
- 时长输入框实时验证输入范围
- 所有操作提供成功/失败反馈
- 加载数据时显示加载动画

## 7. 技术实现要点

### 7.1 组件结构
- `ScenarioManagement`: 主组件，负责整体页面布局和状态管理
- 内部状态管理：
  - 情景列表（scenarios）
  - 大屏列表（availableScreens）
  - 当前编辑的情景数据（editingScenario）
  - 搜索关键词（searchKeyword）
  - 对话框状态（dialogVisible）
  - 操作类型（operationType: 'create'/'edit'）

### 7.2 核心方法实现
- **数据加载方法**：
  - `loadData()`: 从数据源获取情景和大屏数据
  - 支持从MockData获取数据或使用默认数据
  - 错误处理和加载状态管理

- **搜索与筛选**：
  - `handleSearch()`: 根据关键词过滤情景列表
  - `getFilteredScenarios()`: 获取筛选后的情景列表

- **情景操作**：
  - `handleCreate()`: 初始化创建新情景
  - `handleEdit()`: 加载并准备编辑已有情景
  - `handleDelete()`: 处理情景删除（带确认提示）
  - `handleSave()`: 保存情景数据（创建/更新）
  - `handleCancel()`: 取消编辑操作

- **大屏配置操作**：
  - `addScreenToScenario()`: 向情景添加大屏
  - `removeScreenFromScenario()`: 从情景移除大屏
  - `updateScreenDuration()`: 更新大屏展示时长
  - `moveScreenUp()`: 向上移动大屏位置
  - `moveScreenDown()`: 向下移动大屏位置

- **其他辅助方法**：
  - `resetForm()`: 重置表单数据
  - `generateId()`: 生成唯一ID
  - `showMessage()`: 显示操作反馈消息

### 7.3 数据验证
- 情景名称不能为空
- 默认时长必须设置且在5-300秒之间
- 每个大屏的展示时长必须在5-300秒之间
- 至少选择一个大屏才能创建情景
- 验证错误时显示相应的错误提示

### 7.4 界面实现
- 响应式布局设计，适配不同屏幕尺寸
- 使用Element UI组件库实现统一的界面风格
- 搭配FontAwesome图标库提升界面美观性
- 采用模块化设计，代码结构清晰易懂
- 添加适当的动画和过渡效果，提升用户体验

### 7.5 用户体验优化
- 表单输入实时验证，提供错误提示
- 操作成功/失败时显示相应提示
- 加载状态显示
- 确认对话框防止误操作
- 时长输入框添加单位提示
- 播放模式选择添加帮助说明
- 表格支持列排序
- 搜索结果实时更新

## 8. 异常处理机制

- **数据加载失败**：显示加载失败提示，提供重试选项
- **保存失败**：显示错误信息，保持当前编辑状态
- **删除失败**：显示错误信息，恢复被删除的条目
- **数据验证错误**：实时显示错误提示，阻止无效提交
- **网络错误**：显示网络异常提示，支持离线模式下使用缓存数据
- **权限不足**：显示权限不足提示，引导用户联系管理员

## 9. API接口设计

### 9.1 获取情景列表
- URL: `/api/scenarios`
- Method: GET
- Parameters: page, pageSize, search
- Response: `{data: [{...}], total: number, page: number, pageSize: number}`

### 9.2 创建情景
- URL: `/api/scenarios`
- Method: POST
- Body: 情景数据对象
- Response: `{success: boolean, data: {...}, message: string}`

### 9.3 获取情景详情
- URL: `/api/scenarios/:id`
- Method: GET
- Response: `{data: {...}}`

### 9.4 更新情景
- URL: `/api/scenarios/:id`
- Method: PUT
- Body: 更新的情景数据
- Response: `{success: boolean, message: string}`

### 9.5 删除情景
- URL: `/api/scenarios/:id`
- Method: DELETE
- Response: `{success: boolean, message: string}`

## 10. 性能优化考虑

- **数据缓存**：缓存大屏列表数据，减少重复请求
- **分页加载**：情景列表实现分页加载，提升大数据量下的性能
- **延迟加载**：编辑对话框按需加载数据，避免初始加载过多资源
- **防抖搜索**：搜索输入添加防抖处理，避免频繁请求
- **虚拟滚动**：大屏列表使用虚拟滚动，提升大量数据展示性能

## 11. 安全考虑

- **输入验证**：严格验证所有用户输入，防止XSS攻击
- **权限控制**：实现基于角色的访问控制，确保只有授权用户可以执行操作
- **数据加密**：敏感数据传输采用HTTPS加密
- **日志记录**：记录所有关键操作日志，便于审计和问题追溯

## 12. 更新记录

| 版本 | 更新内容 | 更新日期 | 更新人 |
|------|---------|---------|--------|
| 2.0  | 全面更新情景管理功能设计，调整播放模式为顺序/随机，优化数据结构和API设计，完善异常处理机制 | 2024-01-22 | 开发团队 |
| 1.1  | 更新功能描述和实现细节，完善交互逻辑 | 2025-11-17 | 系统管理员 |
| 1.0  | 初始版本，完成基本功能设计 | 2025-11-17 | 系统管理员 |

---

本文档详细描述了情景管理功能的设计方案，包含功能说明、数据结构、交互设计、技术实现要点、API设计和性能优化考虑，可直接用于指导研发团队进行开发实现。所有设计均基于系统实际需求，确保功能完整性和用户体验的最优化。