# 知识库管理功能设计文档

## 1. 功能概述
知识库管理功能允许用户创建、编辑、删除和管理全局和个人知识库，并通过权限控制确保只有授权用户可以访问相应的知识库。

## 2. 功能分类

### 2.1 全局知识库管理
- 由管理员创建和管理
- 可以设置角色权限，只有被分配角色的用户可以访问
- 适用于公司级共享知识资源

### 2.2 个人知识库管理
- 由普通用户创建和管理
- 可以按人员、部门、角色分配访问权限
- 适用于个人或小团队的私有知识资源

## 3. 权限控制设计

### 3.1 全局知识库权限控制

#### 3.1.1 功能描述
全局知识库由管理员进行角色分配，只有被分配角色的人员可以使用该知识库。

#### 3.1.2 权限设置界面
- 在全局知识库创建/编辑界面，管理员可以选择一个或多个角色
- 只有超级管理员和管理员可以设置全局知识库的权限
- 权限设置采用多选下拉框形式

#### 3.1.3 权限验证逻辑
- 用户登录后，系统会检查其角色是否在知识库的授权角色列表中
- 如果用户角色在授权列表中，或者用户是管理员/超级管理员，则可以访问该知识库
- 否则，用户无法看到或访问该知识库

### 3.2 个人知识库权限控制

#### 3.2.1 功能描述
个人知识库由创建者按人员、部门、角色选择分配使用权限。

#### 3.2.2 权限设置界面
- 在个人知识库创建/编辑界面，创建者可以设置三种权限：
  - 人员权限：选择具体的用户
  - 部门权限：选择具体的部门
  - 角色权限：选择具体的角色

#### 3.2.3 权限验证逻辑
- 用户登录后，系统会检查其是否满足以下条件之一：
  1. 用户是知识库的创建者
  2. 用户ID在知识库的人员权限列表中
  3. 用户所在部门在知识库的部门权限列表中
  4. 用户角色在知识库的角色权限列表中
- 如果满足以上条件之一，则可以访问该知识库
- 否则，用户无法看到或访问该知识库

## 4. 数据结构

### 4.1 全局知识库数据结构
```javascript
{
  id: 'global-1',
  name: '企业标准操作流程',
  description: '公司各部门的标准操作流程文档',
  type: 'product',
  enabled: true,
  documentCount: 50,
  lastUpdated: '2025-01-15 14:30:00',
  createdAt: '2025-01-10 10:00:00',
  roles: ['admin', 'editor', 'manager']  // 可以访问的角色列表
}
```

### 4.2 个人知识库数据结构
```javascript
{
  id: 'personal-1',
  name: '我的项目笔记',
  description: '个人项目开发笔记和经验总结',
  type: 'other',
  enabled: true,
  documentCount: 15,
  lastUpdated: '2025-01-16 09:15:00',
  createdAt: '2025-01-12 11:20:00',
  owner: 'user-1',  // 创建者ID
  permissions: {
    users: ['user-2', 'user-3'],  // 可以访问的用户列表
    departments: ['dep-1'],  // 可以访问的部门列表
    roles: ['editor']  // 可以访问的角色列表
  }
}
```

## 5. 实现细节

### 5.1 权限检查函数
```javascript
// 检查用户是否有编辑权限
function hasEditPermission(record) {
  if (!record) return false;
  
  const currentUser = window.App.currentUser || {};
  
  // 超级管理员拥有全部权限
  if (currentUser.role === 'super_admin') {
    return true;
  }
  
  // 管理员可以编辑所有全局知识库和自己的个人知识库
  if (currentUser.role === 'admin') {
    return record.type === 'global' || record.owner === currentUser.id;
  }
  
  // 个人知识库只有创建者可以编辑
  if (record.type === 'personal') {
    return record.owner === currentUser.id;
  }
  
  // 其他情况没有编辑权限
  return false;
}
```

### 5.2 权限过滤逻辑
```javascript
// 全局知识库过滤逻辑
const filteredGlobalKnowledge = globalKnowledgeData.filter(function(knowledge) {
  // 超级管理员和管理员可以看到所有全局知识库
  if (currentUser.role === 'super-admin' || currentUser.role === 'admin') {
    return true;
  }
  // 其他用户只能看到授权给他们角色的全局知识库
  return knowledge.roles.includes(currentUser.role);
});

// 个人知识库过滤逻辑
const filteredPersonalKnowledge = personalKnowledgeData.filter(function(knowledge) {
  // 超级管理员和管理员可以看到所有个人知识库
  if (currentUser.role === 'super-admin' || currentUser.role === 'admin') {
    return true;
  }
  // 创建者可以看到自己的个人知识库
  if (knowledge.owner === currentUser.id) {
    return true;
  }
  // 检查人员权限
  if (knowledge.permissions.users && knowledge.permissions.users.includes(currentUser.id)) {
    return true;
  }
  // 检查部门权限
  if (knowledge.permissions.departments && knowledge.permissions.departments.includes(currentUser.department)) {
    return true;
  }
  // 检查角色权限
  if (knowledge.permissions.roles && knowledge.permissions.roles.includes(currentUser.role)) {
    return true;
  }
  return false;
});
```

## 6. 界面设计

### 6.1 知识库列表页面
- 采用标签页形式区分全局和个人知识库
- 每个知识库显示名称、描述、类型、状态、文档数量等信息
- 操作列显示查看/编辑/删除等按钮，根据用户权限动态显示

### 6.2 知识库创建/编辑页面
- 表单形式，包含名称、描述、类型、启用状态等基本信息
- 根据知识库类型显示不同的权限设置选项：
  - 全局知识库：显示角色选择下拉框
  - 个人知识库：显示人员、部门、角色选择下拉框

#### 6.2.1 个人知识库权限设置实现细节
1. **管理列表页面权限设置**：
   - 在新增或编辑个人知识库时显示权限设置字段
   - 新增时权限设置字段不禁用
   - 编辑时根据hasEditPermission函数检查权限，决定是否禁用

2. **详情页面权限设置**：
   - 在详情页面的编辑模式下显示权限设置字段
   - 加载知识库信息时同时加载权限数据
   - 根据hasEditPermission函数检查权限，决定是否允许修改权限

3. **权限修改流程**：
   - 用户点击"编辑"按钮打开编辑对话框
   - 权限设置字段根据知识库类型和用户权限动态显示
   - 用户修改权限设置后，点击"保存"按钮提交修改
   - 系统验证权限设置的合法性后，更新知识库信息
   - 更新成功后显示提示信息，并关闭编辑对话框

## 7. 异常处理

### 7.1 权限不足
- 当用户尝试访问没有权限的知识库时，系统会隐藏该知识库或显示权限不足提示
- 当用户尝试编辑没有权限的知识库时，系统会禁止编辑操作并显示提示信息

### 7.2 数据验证
- 创建/编辑知识库时，系统会验证必填字段
- 权限设置时，系统会验证至少选择一种权限类型（针对全局知识库）

## 8. 版本历史

| 版本 | 日期 | 变更内容 | 变更人 |
|------|------|----------|--------|
| 1.0 | 2025-01-20 | 初始版本，实现知识库基本管理功能 | 产品团队 |
| 1.1 | 2025-01-25 | 增加全局知识库角色权限控制 | 产品团队 |
| 1.2 | 2025-01-30 | 增加个人知识库多维度权限控制 | 产品团队 |
| 1.3 | 2025-02-05 | 修复个人知识库权限修改功能，确保详情页编辑时权限设置正确显示和可用 | 产品团队 |
